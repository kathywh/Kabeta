.include ../../../tools/kabeta.uasm

|--------------------------------------
| data segment
|--------------------------------------
LOCATE(0)

| stack
stack:
	STORAGE(256)

|--------------------------------------
| I/O segment
|--------------------------------------
LOCATE(0)

EIC_IE:	
	STORAGE(1)		| 0x00
EIC_IN:
	STORAGE(1)		| 0x04

|--------------------------------------
| exception vectors
|--------------------------------------
EXCVT()

rst_vec:
	BR(start)
svc_vec:
	BR(.)
ill_vec:
	BR(.)
inv_op_vec:
	BR(.)
inv_da_vec:
	BR(.)
inv_ia_vec:
	BR(.)
irq0_vec:
	BR(irq0_esr)
irq1_vec:
	| IRQ1 Handler
irq1_esr:
	SUBC(XP, 4, XP)
	PUSH(XP)
	PUSH(R0)
	PUSH(R1)

	MOVC(0x6150, R0)
	MOVC(1, R1)
	OR(R0, R1, R0)

	MOVC(1, R1)
	MOVC(2, R1)
	MOVC(3, R1)
	MOVC(4, R1)

	POP(R1)
	POP(R0)
	POP(XP)

	JMP(XP)

|--------------------------------------
| code segment
|--------------------------------------
LOCATE(0x100)

	| IRQ0 Handler
irq0_esr:
	SUBC(XP, 4, XP)
	PUSH(XP)
	PUSH(R0)
	PUSH(R1)
	PUSH(R21)

	IOR(EIC_IN, R21)

	MOVC(0x6150, R0)
	MOVC(1, R1)
	SHLC(R1, 31, R1)
	OR(R0, R1, R0)

	POP(R21)
	POP(R1)
	POP(R0)
	POP(XP)

	JMP(XP)

start:

	| Set SP
	MOVC(stack, SP)

	| Enable interrupt
	CMOVE(1, R0)
	IOW(R0, EIC_IE)

	| Switch to User Mode
	CMOVE(user_mode%PC_MASK, R0)
	JMP(R0)
user_mode:

	| Set init values of registers
	CMOVE(0x59C1, R0)
	CMOVE(0x59C2, R1)
	BR(test1)
	LONG(0xBAD0)
	LONG(0xBAD1)

test1:
	CMOVE(0x59C3, R2)
	CMOVE(0x59C4, R3)
	CMOVE(0x59C5, R4)
	CMOVE(0x59C6, R5)
	CMOVE(0x59C7, R6)
	CMOVE(0x59C8, R7)
	CMOVE(0x59C9, R8)
	CMOVE(0x8010, R9)
	CMOVE(0x9011, R10)
	CMOVE(0xA212, R11)
	CMOVE(0xB713, R12)
	CMOVE(0xCA14, R13)
	CMOVE(0xFE15, R14)

	| Run OP instructions
	ADD(R0, R1, R15)
	SUB(R2, R14, R16)
	AND(R3, R13, R17)
	OR(R4, R12, R18)
	XOR(R5, R11, R19)
	SHL(R10, R6, R20)
	SHR(R9, R7, R21)
	SRA(R11, R4, R22)
	CMPEQ(R8, R13, R23)
	CMPEQ(R10, R10, R24)
	CMPLT(R13, R4, R25)
	CMPLT(R14, R11, R26)

end:
	BR(.)

|--------------------------------------
| literal segment
|--------------------------------------
LITERAL()
	LONG(0xFEED0001)
	LONG(0xFEED0002)
	LONG(0xFEED0003)
	LONG(0xFEED0004)

|--------------------------------------
| signature
|--------------------------------------
LOCATE(0x0FFC)
__signature:
	LONG(0xCA3EBE3A)
