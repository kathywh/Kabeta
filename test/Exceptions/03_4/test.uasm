.include ../../../tools/kabeta.uasm

||====================================================================================||
||                                    Data Segment                                    ||
||====================================================================================||
LOCATE(0)

| Stack
stack:
	STORAGE(256)

||====================================================================================||
||                                 Exception  Vectors                                 ||
||====================================================================================||
EXCVT()

rst_vec:
	BR(start)
svc_vec:
	BR(.)
ill_vec:
	BR(.)
inv_op_vec:
	BR(.)
inv_da_vec:
	BR(.)
inv_ia_vec:
	BR(.)
irq_vec:
	BR(irq_esr)
urq_vec:
	BR(.)

||====================================================================================||
||                                    Code Segment                                    ||
||====================================================================================||
LOCATE(0x100)

	|-------------------------------------------------------------------------------|
	| IRQ Handler                                                                   |
	|-------------------------------------------------------------------------------|

irq_esr:
	| Adjust & save XP
	SUBC(XP, 4, XP)
	PUSH(XP)

	| Save registers
	PUSH(R0)
	PUSH(R1)
	PUSH(R2)

	| Process interrupt
	MOVC(0x90, R0)
	MOVC(0x91, R1)
	MOVC(0x92, R2)

irq_end:
	| Restore registers
	POP(R2)
	POP(R1)
	POP(R0)

	| Restore XP then return
	POP(XP)
	JMP(XP)

	|-------------------------------------------------------------------------------|
	| System initialization                                                         |
	|-------------------------------------------------------------------------------|

start:

	| Set SP
	MOVC(stack, SP)

	| Switch to User Mode
	MOVC(user_mode%PC_MASK, R0)
	JMP(R0)
user_mode:

	|-------------------------------------------------------------------------------|
	| Main loop                                                                     |
	|-------------------------------------------------------------------------------|
main_loop:
	
	| Main loop body
	MOVC(0x20, R0)
	MOVC(0x21, R1)
	MOVC(0x22, R2)
	BR(target)
	MOVC(0xF0, R0)
	MOVC(0xF1, R1)
	MOVC(0xF2, R2)
target:
	MOV(R0, R31)
	MOV(R1, R31)
	MOV(R2, R31)

	BR(main_loop)

||====================================================================================||
||                                  Literal  Segment                                  ||
||====================================================================================||

|--------------------------------------|
| Program Signature                    |
|--------------------------------------|
LOCATE(0x0FFC)
__signature:
	LONG(0xCA3EBE3A)